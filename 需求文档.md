# Telegram 贪吃蛇链上游戏 - 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 项目名称
Snake Chain Game - 基于 Telegram 群组的区块链贪吃蛇游戏

### 1.2 项目简介
一款创新的区块链社交游戏，玩家通过向指定 TRON 钱包转账参与游戏，系统自动提取交易哈希生成"购彩凭证"，当凭证形成"贪吃蛇"（相同数字首尾相连）时触发中奖机制，奖金自动分配。

### 1.3 核心玩法
- 玩家转账 → 提取哈希 → 生成凭证 → 拼接蛇身 → 匹配中奖 → 自动分账

---

## 2. 业务架构

### 2.1 角色定义

#### 2.1.1 平台管理员
- 管理租户
- 配置系统参数
- 监控游戏运行
- 处理异常情况

#### 2.1.2 租户（群主）
- 创建/管理 Telegram 群
- 绑定群组到系统
- 配置钱包地址
- 设置游戏参数（投注金额、抽成比例等）
- 查看群组游戏数据

#### 2.1.3 玩家（群成员）
- 加入游戏群
- 向指定钱包转账参与游戏
- 查看购彩凭证
- 查看蛇身拼接进度
- 接收中奖通知和奖金

### 2.2 租户系统

#### 2.2.1 租户-群组绑定规则
- **一个群组对应一个租户**
- 群组创建时需验证 Telegram Bot 管理员权限
- 租户可创建多个群组（每个群独立运行游戏）
- 群组 ID (chat_id) 作为唯一标识

#### 2.2.2 租户钱包配置
- 每个租户配置一个 TRON 主钱包地址
- 可选配置：每个群组独立钱包地址
- 钱包地址格式验证（TRON 地址以 T 开头，34 位字符）
- 支持修改钱包地址（需审核/确认机制）

---

## 3. 核心功能详细设计

### 3.1 Telegram 机器人集成

#### 3.1.1 基础命令

| 命令 | 描述 | 权限 | 示例 |
|------|------|------|------|
| `/start` | 启动机器人，显示欢迎信息 | 所有用户 | `/start` |
| `/help` | 显示帮助信息和游戏规则 | 所有用户 | `/help` |
| `/bind <tenant_id>` | 绑定群组到租户 | 群管理员 | `/bind 000001` |
| `/wallet <address>` | 设置/更新钱包地址（10分钟冷却期） | 群管理员 | `/wallet TXYZa2kR6...` |
| `/cancelwallet` | 取消钱包地址变更 | 群管理员 | `/cancelwallet` |
| `/setbet <amount>` | 设置投注金额 | 群管理员 | `/setbet 5` |
| `/setfee <rate>` | 设置平台手续费比例 | 群管理员 | `/setfee 10` |
| `/info` | 查看当前群组配置信息 | 群管理员 | `/info` |
| `/address` | 查看当前群收款钱包地址 | 所有用户 | `/address` |
| `/bindwallet <address>` | 绑定个人钱包地址 | 所有用户 | `/bindwallet TXYZa2kR6...` |
| `/unbindwallet` | 解绑个人钱包地址 | 所有用户 | `/unbindwallet` |
| `/mywallet` | 查看已绑定的钱包地址 | 所有用户 | `/mywallet` |
| `/snake` | 查看当前蛇身状态 | 所有用户 | `/snake` |
| `/mytickets` | 查看我的购彩记录 | 所有用户 | `/mytickets` |
| `/ticket <流水号>` | 查询指定流水号的购彩记录 | 所有用户 | `/ticket 20250108-001` |
| `/stats` | 查看游戏统计数据 | 所有用户 | `/stats` |
| `/history` | 查看历史中奖记录 | 所有用户 | `/history` |
| `/rules` | 查看详细游戏规则 | 所有用户 | `/rules` |

#### 3.1.2 自动消息推送

**1. 购彩成功通知**
```
🎮 购彩成功！

凭证流水号：20250108-001
玩家：@username
购彩凭证：09
投注金额：5 TRX
当前蛇身：09

交易哈希：TxHash123...abc
确认时间：2025-01-08 15:23:45
区块高度：45678901

📝 您可以使用以下命令查询：
/mytickets - 查看我的所有购彩记录
```

**2. 蛇身拼接通知**
```
🐍 蛇身延长！

新增凭证：11
当前蛇身：09 ▸ 11
蛇身长度：2 节
奖池金额：10 TRX

继续转账参与游戏，匹配相同数字即可中奖！
```

**3. 中奖通知**
```
🎉 恭喜中奖！

匹配凭证：11
蛇身区间：11 ▸ 78 ▸ 33 ▸ 11
中奖玩家：
  - @player1 (凭证 11)
  - @player5 (凭证 11)

💰 奖金结算：
区间总额：20 TRX
平台手续费：2 TRX (10%)
奖池金额：18 TRX
每人奖金：9 TRX

转账处理中...
```
**说明：** 如果玩家已通过 `/bindwallet` 绑定钱包地址，系统会自动@对应的 Telegram 用户；未绑定的玩家只显示钱包地址。

**4. 转账完成通知**
```
✅ 奖金已发放！@player1

收款地址：TXYZa2kR6...
到账金额：10 TRX
交易哈希：TxHash789...xyz

感谢参与，祝您好运！
```
**说明：** 转账完成后会私聊@用户（如已绑定），并在群内发送通知。

**5. 钱包绑定成功通知**
```
✅ 钱包绑定成功！

您的 Telegram 账号已绑定钱包地址：
TXYZa2kR6MRWPCsqcBaFCwV9XABqnhYcxk

使用该地址参与游戏中奖后，机器人会自动@您通知。
您可以使用 /mywallet 查看绑定信息。
```

**6. 查询购彩记录响应**
```
📋 您的购彩记录（最近10笔）：

1️⃣ 流水号：20250108-001
   凭证：09 | 金额：5 TRX
   状态：✅ 已中奖
   时间：2025-01-08 10:15:23

2️⃣ 流水号：20250108-015
   凭证：23 | 金额：5 TRX
   状态：🐍 蛇身中
   时间：2025-01-08 14:30:45

3️⃣ 流水号：20250107-089
   凭证：56 | 金额：5 TRX
   状态：✅ 已中奖
   时间：2025-01-07 22:18:12

────────────────
📊 统计：总投注 15 笔 | 中奖 3 笔
💰 总投注：75 TRX | 总奖金：28.5 TRX

使用 /ticket <流水号> 查询详细信息
```

**7. 单笔购彩详细查询**
```
📝 购彩凭证详情

凭证流水号：20250108-001
购彩凭证：09
状态：✅ 已中奖

━━━━━━━━━━━━━━━━━━━━
玩家信息：
玩家：@username
钱包地址：TXYZa2kR6MRWPCsqcBaFCwV9XABqnhYcxk

━━━━━━━━━━━━━━━━━━━━
交易信息：
投注金额：5 TRX
交易哈希：0xabc123...def456
区块高度：45678901
确认时间：2025-01-08 10:15:23

━━━━━━━━━━━━━━━━━━━━
中奖信息：
中奖时间：2025-01-08 10:25:45
匹配凭证：09
奖金金额：9.5 TRX
转账哈希：0xghi789...jkl012
```

**8. 查询群收款地址响应**
```
💰 群组收款地址

━━━━━━━━━━━━━━━━━━━━
当前收款钱包地址：
TXYZa2kR6MRWPCsqcBaFCwV9XABqnhYcxk

━━━━━━━━━━━━━━━━━━━━
📋 游戏信息：
• 投注金额：5 TRX
• 平台手续费：10%
• 钱包周期：第 3 期

━━━━━━━━━━━━━━━━━━━━
💡 使用说明：
1. 向上述地址转账 5 TRX 参与游戏
2. 转账成功后系统自动生成购彩凭证
3. 请勿向其他地址转账，否则无法参与游戏

使用 /help 查看游戏规则
使用 /snake 查看当前蛇身状态
```
**说明：** 所有群成员都可以使用 `/address` 命令查看当前群的收款钱包地址和基本游戏配置。

**9. 钱包地址变更通知**

**9.1 开始变更通知**
```
⚠️ 重要通知：钱包地址即将变更

管理员 @admin 已请求更新收款钱包地址

当前地址：TXYZa2kR6MRWPCsqcBaFCwV9XABqnhYcxk
新地址：TABCdef1234567890abcdefghijklmnop

━━━━━━━━━━━━━━━━━━━━
⏰ 变更倒计时：10分钟

变更开始：2025-01-08 15:00:00
生效时间：2025-01-08 15:10:00

━━━━━━━━━━━━━━━━━━━━
🚫 注意事项：
1. 在此期间请勿向任何地址转账
2. 正在进行中的游戏将继续完成
3. 新交易将在地址变更后才会处理
4. 10分钟后系统将自动切换到新地址

如需取消变更，请管理员使用 /cancelwallet
```

**9.2 倒计时提醒（每10秒）**
```
⏰ 钱包地址变更倒计时

剩余时间：09:50
新地址将在 2025-01-08 15:10:00 生效

🚫 请勿转账到旧地址，否则将无法退款！
```

**9.3 变更完成通知**
```
✅ 钱包地址变更成功！

新收款地址：TABCdef1234567890abcdefghijklmnop

━━━━━━━━━━━━━━━━━━━━
🎮 游戏已恢复正常

现在可以向新地址转账参与游戏了！
旧地址的转账将不再被处理。

使用 /info 查看最新配置
```

**9.4 变更取消通知**
```
❌ 钱包地址变更已取消

管理员 @admin 已取消钱包地址变更操作

当前地址保持不变：
TXYZa2kR6MRWPCsqcBaFCwV9XABqnhYcxk

🎮 游戏已恢复正常，可以继续转账参与！
```

### 3.2 TRON 区块链监听

#### 3.2.1 钱包监听实现

**监听方式：**
1. **方案A：TronGrid API 轮询**
   - 每 3 秒轮询一次钱包交易记录
   - 优点：实现简单，免费
   - 缺点：有延迟，可能漏消息

2. **方案B：TronWeb Events**
   - 订阅钱包事件实时推送
   - 优点：实时性高
   - 缺点：需要节点支持

3. **推荐方案：A + 定时同步**
   - 主要使用轮询方式
   - 每小时全量同步一次防止遗漏

#### 3.2.2 交易筛选规则

**有效交易条件：**
- ✅ 转入金额 = 配置的投注金额（如 5 TRX）
- ✅ 接收地址 = 群组配置的钱包地址
- ✅ 交易状态 = SUCCESS（成功）
- ✅ 交易类型 = TRX Transfer（非合约调用）
- ✅ 发送地址不在黑名单中

**无效交易处理：**
- ❌ 金额不符：发送群组提示消息，不退款
- ❌ 重复交易哈希：同一个 tx_hash 已处理过，直接忽略（防止重复入账）
- ❌ 合约调用：忽略

**说明：**
- ✅ 同一个钱包地址可以**连续多次转账**参与游戏，每次转账都会生成新的购彩凭证
- ❌ 但同一笔交易（相同 tx_hash）只能处理一次，防止系统故障导致重复入账

#### 3.2.3 交易确认机制

**确认规则：**
- 等待至少 **19 个区块确认**（约 57 秒）
- 确认后才生成购彩凭证
- 防止链上回滚导致数据不一致

### 3.3 购彩凭证生成算法

#### 3.3.1 哈希数字提取规则

**算法逻辑：**
```python
def extract_ticket_number(tx_hash: str) -> str:
    """
    从交易哈希中提取两位数字作为购彩凭证

    规则：
    1. 从右向左遍历哈希字符串
    2. 依次判断每个字符是否为数字 (0-9)
    3. 找到两个数字后停止
    4. 如果整个字符串都没有数字，返回 "00"
    5. 如果只找到一个数字，前面补 "0"

    示例：
    - "abc123def456" → "56" (最后两个数字)
    - "abcdef9" → "09" (只有一个数字，补0)
    - "abcdefgh" → "00" (没有数字)
    """
    digits = []
    for char in reversed(tx_hash):
        if char.isdigit():
            digits.append(char)
        if len(digits) == 2:
            break

    if len(digits) == 0:
        return "00"
    elif len(digits) == 1:
        return "0" + digits[0]
    else:
        return digits[1] + digits[0]  # 反转顺序
```

**示例：**
| 交易哈希 | 提取结果 | 说明 |
|---------|---------|------|
| `0x1a2b3c4d5e6f7g8h9i` | `89` | 最后两个数字是 8 和 9 |
| `0xabcdefgh123` | `23` | 最后两个数字是 2 和 3 |
| `0xabcdefg5` | `05` | 只有一个数字 5，补0 |
| `0xabcdefgh` | `00` | 没有数字，返回 00 |

#### 3.3.2 凭证范围
- 最小值：`00`
- 最大值：`99`
- 共 100 种可能性

### 3.4 蛇身拼接与中奖机制

#### 3.4.1 蛇身数据结构

**单节蛇身：**
```typescript
interface SnakeNode {
  id: number;                    // 节点ID
  ticket_number: string;         // 购彩凭证 (00-99)
  player_address: string;        // 玩家钱包地址
  player_tg_username: string;    // Telegram 用户名
  player_tg_user_id: number;     // Telegram 用户ID
  amount: number;                // 投注金额 (TRX)
  tx_hash: string;               // 交易哈希
  block_height: number;          // 区块高度
  created_at: timestamp;         // 创建时间
  status: 'active' | 'matched';  // 状态：活跃/已匹配
}
```

**蛇身链：**
```typescript
interface SnakeChain {
  group_id: number;              // 群组ID
  tenant_id: string;             // 租户ID
  nodes: SnakeNode[];            // 蛇身节点数组（有序）
  pool_amount: number;           // 当前奖池金额
  last_update: timestamp;        // 最后更新时间
}
```

#### 3.4.2 拼接规则

**蛇身显示格式：**
```
09 ▸ 11 ▸ 78 ▸ 33 ▸ 11 ▸ 56
```

**拼接顺序：**
- 按交易确认时间先后顺序
- 新交易追加到蛇尾
- 已匹配的节点从蛇身中移除

#### 3.4.3 中奖匹配算法

**匹配规则（优先级从高到低）：**

##### 🎰 规则1：连号清空奖池（超级大奖）

**触发条件：**
- 当前购彩凭证与上一个节点（最后一个）的凭证**完全相同**
- 示例：`09 ▸ 11 ▸ 78 ▸ 78`（连续两个 78）

**中奖机制：**
- 🏆 **独享大奖**：当前玩家独得所有奖池
- 💰 **奖池范围**：从第一个节点（蛇头）到当前节点的所有金额
- 🧹 **清空蛇身**：所有节点标记为 `matched` 并清空

**示例：**
```
初始蛇身：09 ▸ 11 ▸ 78 ▸ 33

新增节点：33 （索引4，与索引3的 33 相同）
触发条件：✅ 连号匹配！
奖池区间：[0, 4] = 09 ▸ 11 ▸ 78 ▸ 33 ▸ 33
区间金额：5 + 5 + 5 + 5 + 5 = 25 TRX

中奖玩家：
- 索引4的玩家（当前购彩者）

独享奖金：25 TRX（扣除平台抽成后）

匹配后蛇身：（空）
（所有节点已清空）
```

**概率分析：**
- 连号概率：1/100
- 由于概率极低，奖池积累更大，奖金更丰厚
- 这是游戏中的"头奖"机制

---

##### 🐍 规则2：区间匹配（常规奖励）

**触发条件：**
- 当前节点凭证与**历史节点**中某个节点相同
- 但**不是上一个节点**（避免与规则1冲突）

**中奖机制：**
- 👥 **平分奖金**：两个匹配节点的玩家平分
- 💰 **奖池范围**：两个匹配节点之间的区间
- 📍 **移除区间**：只移除匹配区间内的节点

**示例：**
```
初始蛇身：09 ▸ 11 ▸ 78 ▸ 33

新增节点：11 （索引4）
扫描发现：索引1 也是 11（不是上一个节点）
匹配区间：[1, 4] = 11 ▸ 78 ▸ 33 ▸ 11
区间金额：5 + 5 + 5 + 5 = 20 TRX

中奖玩家：
- 索引1的玩家（凭证 11）
- 索引4的玩家（凭证 11）

每人奖金：20 / 2 = 10 TRX

匹配后蛇身：09
（索引1-4的节点已移除）
```

---

**匹配优先级：**
1. **优先检查规则1**（连号）：与上一个节点比较
2. **再检查规则2**（区间）：与所有历史节点比较
3. **一次只处理一个匹配**：按优先级触发
4. **下次新节点重新扫描**：剩余蛇身继续游戏

**边界情况：**
- 蛇身为空时，第一个节点无法触发任何匹配
- 蛇身只有1个节点时，第二个节点可能触发连号匹配
- 连续触发连号的概率极低（1/10000），但理论上可行

#### 3.4.4 中奖分账逻辑

**分账规则：**
1. **基础分账：**
   - 区间总金额扣除平台手续费后平分给中奖玩家
   - 平台手续费：可配置（默认 10%）
   - 实际奖金 = (区间总金额 - 平台手续费) / 中奖人数

2. **计算公式：**
   ```
   区间总金额 = Σ(节点i到节点j的投注金额)
   平台手续费 = 区间总金额 × 手续费比例
   奖池金额 = 区间总金额 - 平台手续费
   每人奖金 = 奖池金额 / 中奖人数
   ```

3. **示例计算（手续费 10%）：**
   ```
   区间金额：20 TRX
   手续费比例：10%
   平台手续费：20 × 10% = 2 TRX
   奖池金额：20 - 2 = 18 TRX
   中奖人数：2 人
   每人奖金：18 / 2 = 9 TRX
   ```

4. **示例计算（手续费 5%）：**
   ```
   区间金额：20 TRX
   手续费比例：5%
   平台手续费：20 × 5% = 1 TRX
   奖池金额：20 - 1 = 19 TRX
   中奖人数：2 人
   每人奖金：19 / 2 = 9.5 TRX
   ```

5. **连号大奖计算（独享奖池）：**
   ```
   区间金额：100 TRX（从蛇头到当前节点所有金额）
   手续费比例：10%
   平台手续费：100 × 10% = 10 TRX
   奖池金额：100 - 10 = 90 TRX
   中奖人数：1 人（独享）
   奖金：90 TRX
   ```

**重要说明：**
- 平台手续费在开奖时自动扣除
- 手续费收入归平台所有
- 手续费比例可通过后台管理界面调整（0% ~ 50%）
- 所有交易和手续费记录可审计追溯

### 3.5 自动转账实现

#### 3.5.1 钱包授权方案

**方案A：私钥托管（简单但不安全）**
- 租户提供钱包私钥
- 系统代为管理和转账
- ❌ 安全风险极高，不推荐

**方案B：多签钱包（安全但复杂）**
- 使用 TRON 多签钱包
- 需要多方签名才能转账
- ✅ 安全性高
- ❌ 实现复杂，用户门槛高

**方案C：热钱包 + 冷钱包（推荐）**
- 热钱包：存放少量资金，用于自动转账
- 冷钱包：存放大额资金，手动充值热钱包
- ✅ 平衡安全性和便利性
- 资金流：玩家→热钱包→中奖玩家

#### 3.5.2 转账流程

**步骤：**
1. **中奖触发**
   - 检测到匹配，生成中奖记录
   - 状态：`pending_transfer`

2. **转账前检查**
   - 验证热钱包余额是否充足
   - 余额不足：发送通知给租户，暂停转账
   - 余额充足：继续

3. **执行转账**
   - 调用 TronWeb API 发起转账
   - 记录交易哈希
   - 状态：`transferring`

4. **确认转账**
   - 等待交易上链确认（19个区块）
   - 确认成功：状态 `completed`
   - 确认失败：状态 `failed`，重试或人工处理

5. **通知玩家**
   - 推送 Telegram 消息
   - 包含转账哈希和到账金额

#### 3.5.3 异常处理

| 异常情况 | 处理方式 |
|---------|---------|
| 余额不足 | 暂停转账,通知租户充值，记录待处理订单 |
| 网络超时 | 重试3次，失败后人工介入 |
| 转账失败 | 记录错误日志，标记订单为失败，人工处理 |
| 玩家地址无效 | 跳过该玩家，记录异常，通知管理员 |
| Gas 费用不足 | 提高 Gas 费用重试，或通知管理员 |

### 3.6 钱包变更业务规则

#### 3.6.1 钱包变更触发条件

**触发方式：**
- 群组管理员执行 `/wallet <新地址>` 命令
- 系统验证管理员权限和新地址格式
- 触发10分钟冷却期倒计时

**前置检查：**
- ✅ 新地址必须是有效的TRON地址格式
- ✅ 不能与当前地址相同
- ✅ 群组状态为 `wallet_change_status='normal'`（没有正在进行的变更）

#### 3.6.2 钱包变更流程

**阶段1：开始变更（冷却期）**

1. **更新群组状态：**
   ```php
   $group->update([
       'pending_wallet_address' => $newAddress,
       'wallet_change_status' => 'changing',
       'wallet_change_start_at' => now(),
       'wallet_change_end_at' => now()->addMinutes(10)
   ]);
   ```

2. **发送开始通知：**
   - 显示当前地址和新地址
   - 显示当前游戏状态（节点数、奖池金额）
   - 警告：游戏状态将被重置
   - 警告：未中奖凭证不退款
   - 提示可以取消变更

3. **每10秒发送倒计时提醒：**
   - 显示剩余时间（格式：MM:SS）
   - 重复警告不要转账

4. **期间处理：**
   - 拒绝所有新交易处理
   - 已确认但未处理的交易会被拒绝
   - 发送错误提示消息

**阶段2：完成变更（10分钟后自动执行）**

1. **开启数据库事务：**
   ```php
   DB::beginTransaction();
   ```

2. **归档所有活跃节点：**
   ```php
   SnakeNode::where('group_id', $groupId)
       ->where('status', 'active')
       ->update(['status' => 'archived']);
   ```
   - 这些节点的 `wallet_cycle` 保持为旧的周期编号
   - `matched_prize_id` 保持为 NULL（未中奖）
   - 不会触发任何退款操作

3. **增加钱包周期计数：**
   ```php
   $newWalletCycle = $group->wallet_change_count + 1;
   ```

4. **更新群组配置：**
   ```php
   $group->update([
       'wallet_address' => $newAddress,
       'wallet_change_count' => $newWalletCycle,
       'pending_wallet_address' => null,
       'wallet_change_status' => 'normal',
       'wallet_change_start_at' => null,
       'wallet_change_end_at' => null
   ]);
   ```

5. **提交事务：**
   ```php
   DB::commit();
   ```

6. **发送完成通知：**
   - 显示新地址
   - 显示旧周期和新周期编号
   - 显示归档的节点数量
   - 显示清空的奖池金额
   - 提示历史中奖记录已保留

#### 3.6.3 钱包变更的数据影响

**1. 蛇身节点（snake_node）**

| 原状态 | 变更后状态 | wallet_cycle | 说明 |
|-------|----------|-------------|------|
| `active` | `archived` | 保持旧周期 | 未中奖的活跃节点被归档 |
| `matched` | `matched` | 保持旧周期 | 已中奖记录不受影响 |
| `cancelled` | `cancelled` | 保持旧周期 | 已取消记录不受影响 |

**2. 中奖记录（prize_record）**

- ✅ 所有历史中奖记录**完全保留**
- ✅ 通过 `wallet_cycle` 字段区分不同钱包周期
- ✅ 可以查询任意周期的中奖记录

**3. 奖池金额**

- ❌ **奖池清零**：所有未中奖的投注金额不退款
- 💰 这些资金归租户所有（群主的钱包收到了这些TRX）
- 📝 归档节点的金额总和会在通知中显示

**4. 游戏状态**

- 🆕 新游戏从第一个节点开始
- 🐍 蛇身从空开始拼接
- 🎮 所有匹配规则重新生效

#### 3.6.4 查询历史数据

**查询指定周期的数据：**
```php
// 查询第3个钱包周期的活跃节点（已归档）
$nodes = SnakeNode::where('group_id', $groupId)
    ->where('wallet_cycle', 3)
    ->where('status', 'archived')
    ->get();

// 查询第2个钱包周期的中奖记录
$prizes = PrizeRecord::where('group_id', $groupId)
    ->where('wallet_cycle', 2)
    ->get();
```

**查询当前周期的数据：**
```php
$group = GameGroup::find($groupId);
$currentCycle = $group->wallet_change_count;

// 查询当前周期的活跃节点
$activeNodes = SnakeNode::where('group_id', $groupId)
    ->where('wallet_cycle', $currentCycle)
    ->where('status', 'active')
    ->get();
```

#### 3.6.5 取消钱包变更

**取消条件：**
- 必须在10分钟冷却期内
- 管理员执行 `/cancelwallet` 命令

**取消操作：**
```php
$group->update([
    'pending_wallet_address' => null,
    'wallet_change_status' => 'normal',
    'wallet_change_start_at' => null,
    'wallet_change_end_at' => null
]);
```

**取消后：**
- 游戏立即恢复正常
- 继续使用原钱包地址
- 蛇身和奖池不受影响
- 发送取消通知

#### 3.6.6 重要业务规则

**⚠️ 资金不可退还：**
- 钱包变更时，所有未中奖的购彩凭证**不退款**
- 玩家的投注金额已经转入了租户钱包
- 这是游戏规则的一部分，需要在群规则中明确说明

**📊 数据可追溯：**
- 所有历史数据通过 `wallet_cycle` 字段永久保留
- 可以查询任意周期的游戏数据
- 方便审计和纠纷处理

**🔒 操作不可逆：**
- 钱包变更完成后无法撤销
- 归档的节点无法恢复为活跃状态
- 清空的奖池无法恢复

**⏰ 冷却期保护：**
- 10分钟冷却期给玩家充足的警告时间
- 60次提醒确保所有在线玩家都能看到
- 防止管理员误操作

---

## 4. 数据库设计

### 4.1 核心数据表

#### 4.1.1 tenant（租户表）
```sql
CREATE TABLE tenant (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  tenant_id VARCHAR(20) UNIQUE NOT NULL COMMENT '租户编号',
  company_name VARCHAR(200) NOT NULL COMMENT '租户名称',
  contact_phone VARCHAR(20) COMMENT '联系电话',
  status TINYINT DEFAULT 1 COMMENT '状态 1-正常 0-停用',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_tenant_id (tenant_id)
);
```

#### 4.1.2 game_group（游戏群组表）
```sql
CREATE TABLE game_group (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  tenant_id VARCHAR(20) NOT NULL COMMENT '租户ID',
  tg_chat_id BIGINT UNIQUE NOT NULL COMMENT 'Telegram群组ID',
  tg_chat_title VARCHAR(255) NOT NULL COMMENT '群组名称',
  wallet_address VARCHAR(34) NOT NULL COMMENT 'TRON钱包地址',
  wallet_change_count INT DEFAULT 0 COMMENT '钱包变更次数（用于区分不同钱包周期）',
  pending_wallet_address VARCHAR(34) COMMENT '待更新的钱包地址',
  wallet_change_status ENUM('normal', 'changing') DEFAULT 'normal' COMMENT '钱包变更状态',
  wallet_change_start_at TIMESTAMP NULL COMMENT '钱包变更开始时间',
  wallet_change_end_at TIMESTAMP NULL COMMENT '钱包变更生效时间',
  hot_wallet_address VARCHAR(34) COMMENT '热钱包地址（用于转账）',
  hot_wallet_private_key VARCHAR(128) COMMENT '热钱包私钥（加密存储）',
  bet_amount DECIMAL(10,4) DEFAULT 5.0000 COMMENT '投注金额(TRX)',
  platform_fee_rate DECIMAL(5,4) DEFAULT 0.1000 COMMENT '平台手续费比例(默认10%)',
  status TINYINT DEFAULT 1 COMMENT '状态 1-正常 0-停用',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_tenant_id (tenant_id),
  INDEX idx_tg_chat_id (tg_chat_id),
  INDEX idx_wallet_change_status (wallet_change_status)
) COMMENT='游戏群组配置表';
```

**字段说明：**
- `wallet_address`: 当前生效的钱包地址
- `wallet_change_count`: 钱包变更次数，用于区分不同钱包周期（每次变更+1）
- `pending_wallet_address`: 待更新的新钱包地址（冷却期期间存储）
- `wallet_change_status`: 钱包变更状态
  - `normal`: 正常状态，可以接受游戏
  - `changing`: 变更中，停止接受新游戏
- `wallet_change_start_at`: 开始变更的时间
- `wallet_change_end_at`: 预计变更生效时间（开始时间 + 10分钟）

**手续费说明：**
- `platform_fee_rate`: 平台手续费比例，取值范围 0.0000 ~ 0.5000（0% ~ 50%）
- 默认值：0.1000（10%）
- 可通过后台管理界面配置
- 每次开奖时从奖池金额中扣除

#### 4.1.3 snake_node（蛇身节点表）
```sql
CREATE TABLE snake_node (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  group_id BIGINT NOT NULL COMMENT '群组ID',
  wallet_cycle INT NOT NULL COMMENT '钱包周期（对应wallet_change_count）',
  ticket_number CHAR(2) NOT NULL COMMENT '购彩凭证(00-99)',
  ticket_serial_no VARCHAR(30) NOT NULL COMMENT '凭证流水号(格式: YYYYMMDD-序号，如: 20250108-001)',
  player_address VARCHAR(34) NOT NULL COMMENT '玩家钱包地址',
  player_tg_username VARCHAR(100) COMMENT 'Telegram用户名',
  player_tg_user_id BIGINT COMMENT 'Telegram用户ID',
  amount DECIMAL(10,4) NOT NULL COMMENT '投注金额',
  tx_hash VARCHAR(64) UNIQUE NOT NULL COMMENT '交易哈希',
  block_height BIGINT NOT NULL COMMENT '区块高度',
  node_index INT NOT NULL COMMENT '节点序号（在蛇身中的位置）',
  daily_sequence INT NOT NULL COMMENT '当天第几笔交易（从1开始）',
  status ENUM('active', 'matched', 'cancelled', 'archived') DEFAULT 'active' COMMENT '状态',
  matched_prize_id BIGINT COMMENT '匹配的中奖记录ID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_group_status (group_id, status),
  INDEX idx_tx_hash (tx_hash),
  INDEX idx_player (player_address, group_id),
  INDEX idx_serial_no (ticket_serial_no),
  INDEX idx_daily_sequence (group_id, created_at, daily_sequence),
  INDEX idx_wallet_cycle (group_id, wallet_cycle, status)
) COMMENT='蛇身节点记录表';
```

**新增字段说明：**
- `wallet_cycle`: 钱包周期，记录节点属于哪个钱包周期（对应 `game_group.wallet_change_count`）
- `status` 新增状态：
  - `active`: 活跃状态，参与游戏
  - `matched`: 已中奖
  - `cancelled`: 已取消（未中奖就被清空）
  - `archived`: 已归档（钱包变更时的历史数据）

**钱包变更时的处理：**
- 所有 `status='active'` 的节点标记为 `archived`
- 历史中奖记录（`status='matched'`）保持不变，但可通过 `wallet_cycle` 区分
- 新游戏使用新的 `wallet_cycle`

#### 4.1.4 prize_record（中奖记录表）
```sql
CREATE TABLE prize_record (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  group_id BIGINT NOT NULL COMMENT '群组ID',
  wallet_cycle INT NOT NULL COMMENT '钱包周期（对应wallet_change_count）',
  ticket_number CHAR(2) NOT NULL COMMENT '中奖凭证',
  start_node_id BIGINT NOT NULL COMMENT '起始节点ID',
  end_node_id BIGINT NOT NULL COMMENT '结束节点ID',
  total_amount DECIMAL(10,4) NOT NULL COMMENT '区间总金额',
  platform_fee DECIMAL(10,4) NOT NULL COMMENT '平台抽成',
  prize_pool DECIMAL(10,4) NOT NULL COMMENT '奖池金额',
  prize_per_winner DECIMAL(10,4) NOT NULL COMMENT '每人奖金',
  winner_count TINYINT DEFAULT 2 COMMENT '中奖人数',
  status ENUM('pending', 'transferring', 'completed', 'failed') DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_group_id (group_id),
  INDEX idx_status (status),
  INDEX idx_wallet_cycle (group_id, wallet_cycle)
) COMMENT='中奖记录表';
```

**新增字段说明：**
- `wallet_cycle`: 钱包周期，记录该中奖属于哪个钱包周期
- 用于区分不同钱包地址时期的中奖记录
- 便于统计和审计

#### 4.1.5 prize_transfer（奖金转账表）
```sql
CREATE TABLE prize_transfer (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  prize_record_id BIGINT NOT NULL COMMENT '中奖记录ID',
  node_id BIGINT NOT NULL COMMENT '中奖节点ID',
  to_address VARCHAR(34) NOT NULL COMMENT '收款地址',
  amount DECIMAL(10,4) NOT NULL COMMENT '转账金额',
  tx_hash VARCHAR(64) COMMENT '转账交易哈希',
  status ENUM('pending', 'processing', 'success', 'failed') DEFAULT 'pending',
  retry_count INT DEFAULT 0 COMMENT '重试次数',
  error_message TEXT COMMENT '错误信息',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_prize_record (prize_record_id),
  INDEX idx_status (status),
  INDEX idx_tx_hash (tx_hash)
) COMMENT='奖金转账记录表';
```

#### 4.1.6 tron_transaction_log（TRON交易日志表）
```sql
CREATE TABLE tron_transaction_log (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  group_id BIGINT NOT NULL COMMENT '群组ID',
  tx_hash VARCHAR(64) UNIQUE NOT NULL COMMENT '交易哈希',
  from_address VARCHAR(34) NOT NULL COMMENT '发送地址',
  to_address VARCHAR(34) NOT NULL COMMENT '接收地址',
  amount DECIMAL(10,4) NOT NULL COMMENT '金额(TRX)',
  block_height BIGINT NOT NULL COMMENT '区块高度',
  block_timestamp BIGINT NOT NULL COMMENT '区块时间戳',
  status VARCHAR(20) NOT NULL COMMENT '交易状态',
  is_valid TINYINT DEFAULT 0 COMMENT '是否有效交易',
  invalid_reason VARCHAR(255) COMMENT '无效原因',
  processed TINYINT DEFAULT 0 COMMENT '是否已处理',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_group_id (group_id),
  INDEX idx_to_address (to_address),
  INDEX idx_block_height (block_height),
  INDEX idx_processed (processed)
) COMMENT='TRON交易监听日志表';
```

#### 4.1.7 player_wallet_binding（玩家钱包绑定表）
```sql
CREATE TABLE player_wallet_binding (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  group_id BIGINT NOT NULL COMMENT '群组ID',
  tg_user_id BIGINT NOT NULL COMMENT 'Telegram用户ID',
  tg_username VARCHAR(100) COMMENT 'Telegram用户名',
  tg_first_name VARCHAR(100) COMMENT 'Telegram名字',
  tg_last_name VARCHAR(100) COMMENT 'Telegram姓氏',
  wallet_address VARCHAR(34) NOT NULL COMMENT '绑定的钱包地址',
  status TINYINT DEFAULT 1 COMMENT '状态 1-正常 0-已解绑',
  bind_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '绑定时间',
  unbind_at TIMESTAMP NULL COMMENT '解绑时间',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_group_user (group_id, tg_user_id) COMMENT '同一群组同一用户只能有一个有效绑定',
  INDEX idx_wallet_address (wallet_address),
  INDEX idx_group_id (group_id),
  INDEX idx_tg_user_id (tg_user_id)
) COMMENT='玩家钱包绑定表';
```

**业务规则：**
- 一个 Telegram 用户在同一群组只能绑定一个钱包地址
- 不同群组可以绑定不同地址
- 一个钱包地址可以被多个用户绑定（不常见但允许）
- 解绑后 `status` 改为 0，记录 `unbind_at`
- 重新绑定会更新原记录，而不是新增

#### 4.1.8 platform_fee_record（平台手续费记录表）
```sql
CREATE TABLE platform_fee_record (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  group_id BIGINT NOT NULL COMMENT '群组ID',
  prize_record_id BIGINT NOT NULL COMMENT '中奖记录ID',
  total_amount DECIMAL(10,4) NOT NULL COMMENT '区间总金额',
  fee_rate DECIMAL(5,4) NOT NULL COMMENT '手续费比例',
  fee_amount DECIMAL(10,4) NOT NULL COMMENT '手续费金额',
  prize_pool DECIMAL(10,4) NOT NULL COMMENT '扣除手续费后的奖池',
  fee_status ENUM('pending', 'collected', 'failed') DEFAULT 'pending' COMMENT '收取状态',
  remark VARCHAR(500) COMMENT '备注',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_group_id (group_id),
  INDEX idx_prize_record_id (prize_record_id),
  INDEX idx_created_at (created_at),
  INDEX idx_fee_status (fee_status)
) COMMENT='平台手续费记录表';
```

**业务规则：**
- 每次中奖开奖时自动创建手续费记录
- 记录当时的手续费比例（历史可追溯）
- 用于财务统计和审计
- 支持按时间、按群组查询手续费收入

---

## 5. 技术实现方案

### 5.1 技术栈

#### 5.1.1 后端
- **框架：** Webman (PHP 8.1+)
- **数据库：** MySQL 5.7+
- **缓存：** Redis 6.0+
- **队列：** Redis Queue
- **区块链：** TronWeb API / TronGrid API

#### 5.1.2 第三方服务
- **Telegram Bot API：** 消息推送和命令处理
- **TRON API：**
  - TronGrid（官方）：https://api.trongrid.io
  - TronScan API：https://apilist.tronscan.org
- **OCR 服务：** 可选，用于识别转账截图

### 5.2 核心模块架构

```
snake-server/
├── app/
│   ├── controller/
│   │   └── GameController.php          # 游戏控制器
│   ├── service/
│   │   ├── TronMonitorService.php      # TRON监听服务
│   │   ├── SnakeGameService.php        # 游戏逻辑服务
│   │   ├── PrizeService.php            # 中奖处理服务
│   │   ├── TransferService.php         # 转账服务
│   │   ├── TelegramBotService.php      # Telegram机器人服务
│   │   ├── PlayerWalletService.php     # 玩家钱包绑定服务
│   │   ├── PlatformFeeService.php      # 平台手续费服务
│   │   └── WalletChangeService.php     # 钱包变更服务
│   ├── repository/
│   │   ├── GameGroupRepository.php
│   │   ├── SnakeNodeRepository.php
│   │   ├── PrizeRecordRepository.php
│   │   ├── PlayerWalletBindingRepository.php
│   │   └── PlatformFeeRecordRepository.php
│   ├── queue/
│   │   ├── TronTxProcessQueue.php      # 交易处理队列
│   │   └── PrizeTransferQueue.php      # 转账队列
│   ├── process/
│   │   ├── TronMonitorCrontab.php      # TRON监听定时任务
│   │   └── WalletChangeNotifier.php    # 钱包变更通知定时任务
│   └── model/
│       ├── ModelGameGroup.php
│       ├── ModelSnakeNode.php
│       ├── ModelPrizeRecord.php
│       ├── ModelPlayerWalletBinding.php
│       └── ModelPlatformFeeRecord.php
```

### 5.3 关键流程实现

#### 5.3.1 TRON 交易监听流程
```php
// 伪代码
class TronMonitorCrontab {
    public function run() {
        // 1. 获取所有活跃群组
        $groups = GameGroup::where('status', 1)->get();

        foreach ($groups as $group) {
            // 2. 获取最后处理的区块高度
            $lastBlock = $this->getLastProcessedBlock($group->id);

            // 3. 查询新交易
            $transactions = TronAPI::getTransactions([
                'address' => $group->wallet_address,
                'min_block_height' => $lastBlock + 1
            ]);

            foreach ($transactions as $tx) {
                // 4. 验证交易
                if ($this->validateTransaction($tx, $group)) {
                    // 5. 推入处理队列
                    Redis::send('tron-tx-process', [
                        'group_id' => $group->id,
                        'tx_hash' => $tx['hash']
                    ]);
                }
            }
        }
    }
}
```

#### 5.3.2 购彩凭证生成流程
```php
class SnakeGameService {
    public function processTransaction($groupId, $txHash) {
        // 1. 获取交易详情
        $tx = TronAPI::getTransactionByHash($txHash);

        // 2. 提取购彩凭证
        $ticketNumber = $this->extractTicketNumber($tx['hash']);

        // 3. 查询钱包绑定信息（获取Telegram用户信息）
        $walletBinding = PlayerWalletBinding::where('group_id', $groupId)
            ->where('wallet_address', $tx['from'])
            ->where('status', 1)
            ->first();

        // 4. 生成凭证流水号
        $ticketSerialNo = $this->generateTicketSerialNo($groupId);

        // 5. 获取当天交易序号
        $dailySequence = $this->getDailySequence($groupId);

        // 6. 创建蛇身节点
        $node = SnakeNode::create([
            'group_id' => $groupId,
            'ticket_number' => $ticketNumber,
            'ticket_serial_no' => $ticketSerialNo,
            'player_address' => $tx['from'],
            'player_tg_username' => $walletBinding ? $walletBinding->tg_username : null,
            'player_tg_user_id' => $walletBinding ? $walletBinding->tg_user_id : null,
            'amount' => $tx['amount'],
            'tx_hash' => $tx['hash'],
            'block_height' => $tx['block_height'],
            'node_index' => $this->getNextNodeIndex($groupId),
            'daily_sequence' => $dailySequence
        ]);

        // 7. 推送Telegram消息（如果有绑定则@用户）
        $this->sendTicketNotification($groupId, $node, $walletBinding);

        // 8. 检查匹配
        $this->checkMatch($groupId, $node);
    }

    /**
     * 生成凭证流水号：格式 YYYYMMDD-序号
     */
    private function generateTicketSerialNo($groupId) {
        $today = date('Ymd');

        // 查询今天该群组已有的交易数量
        $todayCount = SnakeNode::where('group_id', $groupId)
            ->whereDate('created_at', date('Y-m-d'))
            ->count();

        $sequence = str_pad($todayCount + 1, 3, '0', STR_PAD_LEFT);

        return $today . '-' . $sequence;
    }

    /**
     * 获取当天交易序号
     */
    private function getDailySequence($groupId) {
        // 查询今天该群组已有的交易数量
        $todayCount = SnakeNode::where('group_id', $groupId)
            ->whereDate('created_at', date('Y-m-d'))
            ->count();

        return $todayCount + 1;
    }

    private function extractTicketNumber($txHash) {
        $digits = [];
        for ($i = strlen($txHash) - 1; $i >= 0; $i--) {
            if (is_numeric($txHash[$i])) {
                $digits[] = $txHash[$i];
                if (count($digits) == 2) break;
            }
        }

        if (count($digits) == 0) return '00';
        if (count($digits) == 1) return '0' . $digits[0];
        return $digits[1] . $digits[0];
    }

    private function sendTicketNotification($groupId, $node, $walletBinding) {
        $message = "🎮 购彩成功！\n\n";
        $message .= "凭证流水号：{$node->ticket_serial_no}\n";

        // 如果有绑定则@用户，否则只显示地址
        if ($walletBinding) {
            $message .= "玩家：@{$walletBinding->tg_username}\n";
        } else {
            $message .= "玩家：{$node->player_address}\n";
        }

        $message .= "购彩凭证：{$node->ticket_number}\n";
        $message .= "投注金额：{$node->amount} TRX\n\n";
        $message .= "交易哈希：{$node->tx_hash}\n";
        $message .= "确认时间：" . $node->created_at->format('Y-m-d H:i:s') . "\n";
        $message .= "区块高度：{$node->block_height}\n\n";
        $message .= "📝 您可以使用以下命令查询：\n";
        $message .= "/mytickets - 查看我的所有购彩记录";

        TelegramBot::sendMessage($groupId, $message);
    }
}
```

#### 5.3.3 中奖匹配流程
```php
class SnakeGameService {
    public function checkMatch($groupId, $newNode) {
        // 1. 获取当前活跃蛇身
        $activeNodes = SnakeNode::where('group_id', $groupId)
            ->where('status', 'active')
            ->orderBy('node_index')
            ->get();

        // 2. 从头部开始扫描匹配
        foreach ($activeNodes as $index => $node) {
            if ($node->ticket_number === $newNode->ticket_number
                && $node->id !== $newNode->id) {
                // 找到匹配！
                $this->handleMatch($groupId, $node, $newNode, $activeNodes);
                return;
            }
        }
    }

    private function handleMatch($groupId, $startNode, $endNode, $nodes) {
        // 1. 计算区间
        $matchedNodes = $this->getNodesBetween($nodes, $startNode, $endNode);

        // 2. 获取群组配置
        $group = GameGroup::find($groupId);

        // 3. 计算奖金
        $totalAmount = array_sum(array_column($matchedNodes, 'amount'));
        $platformFee = $totalAmount * $group->platform_fee_rate;
        $prizePool = $totalAmount - $platformFee;
        $prizePerWinner = $prizePool / 2;

        // 4. 创建中奖记录
        $prizeRecord = PrizeRecord::create([
            'group_id' => $groupId,
            'ticket_number' => $startNode->ticket_number,
            'start_node_id' => $startNode->id,
            'end_node_id' => $endNode->id,
            'total_amount' => $totalAmount,
            'platform_fee' => $platformFee,
            'prize_pool' => $prizePool,
            'prize_per_winner' => $prizePerWinner
        ]);

        // 5. 创建手续费记录
        PlatformFeeRecord::create([
            'group_id' => $groupId,
            'prize_record_id' => $prizeRecord->id,
            'total_amount' => $totalAmount,
            'fee_rate' => $group->platform_fee_rate,
            'fee_amount' => $platformFee,
            'prize_pool' => $prizePool,
            'fee_status' => 'pending'
        ]);

        // 6. 标记节点为已匹配
        foreach ($matchedNodes as $node) {
            $node->update([
                'status' => 'matched',
                'matched_prize_id' => $prizeRecord->id
            ]);
        }

        // 7. 推送中奖通知（支持@用户）
        $this->sendPrizeNotification($groupId, $prizeRecord, $startNode, $endNode);

        // 8. 触发转账
        $this->triggerTransfer($prizeRecord);
    }

    private function sendPrizeNotification($groupId, $prizeRecord, $startNode, $endNode) {
        $message = "🎉 恭喜中奖！\n\n";
        $message .= "匹配凭证：{$prizeRecord->ticket_number}\n\n";

        // 中奖玩家列表
        $message .= "中奖玩家：\n";
        $winners = [$startNode, $endNode];
        foreach ($winners as $winner) {
            if ($winner->player_tg_username) {
                $message .= "  - @{$winner->player_tg_username} (凭证 {$winner->ticket_number})\n";
            } else {
                $message .= "  - {$winner->player_address} (凭证 {$winner->ticket_number})\n";
            }
        }

        // 奖金结算信息
        $message .= "\n💰 奖金结算：\n";
        $message .= "区间总额：{$prizeRecord->total_amount} TRX\n";

        // 获取群组配置以显示手续费比例
        $group = GameGroup::find($groupId);
        $feeRate = $group->platform_fee_rate * 100; // 转换为百分比

        $message .= "平台手续费：{$prizeRecord->platform_fee} TRX ({$feeRate}%)\n";
        $message .= "奖池金额：{$prizeRecord->prize_pool} TRX\n";
        $message .= "每人奖金：{$prizeRecord->prize_per_winner} TRX\n\n";
        $message .= "转账处理中...";

        TelegramBot::sendMessage($groupId, $message);
    }
}
```

#### 5.3.4 自动转账流程
```php
class TransferService {
    public function processTransfer($prizeRecordId) {
        $prize = PrizeRecord::find($prizeRecordId);
        $winners = $this->getWinners($prize);

        foreach ($winners as $winner) {
            try {
                // 1. 检查余额
                $balance = $this->checkHotWalletBalance($prize->group_id);
                if ($balance < $prize->prize_per_winner) {
                    $this->notifyInsufficientBalance($prize->group_id);
                    break;
                }

                // 2. 执行转账
                $txHash = TronAPI::transfer([
                    'from' => $hotWallet,
                    'to' => $winner->player_address,
                    'amount' => $prize->prize_per_winner
                ]);

                // 3. 记录转账
                PrizeTransfer::create([
                    'prize_record_id' => $prize->id,
                    'node_id' => $winner->id,
                    'to_address' => $winner->player_address,
                    'amount' => $prize->prize_per_winner,
                    'tx_hash' => $txHash,
                    'status' => 'processing'
                ]);

                // 4. 推送通知
                $this->sendTransferNotification($winner, $txHash);

            } catch (Exception $e) {
                // 记录错误，稍后重试
                Log::error('Transfer failed', [
                    'prize_id' => $prize->id,
                    'winner' => $winner->player_address,
                    'error' => $e->getMessage()
                ]);
            }
        }
    }
}
```

#### 5.3.5 玩家钱包绑定流程
```php
class PlayerWalletService {
    /**
     * 绑定钱包地址
     */
    public function bindWallet($groupId, $tgUserId, $tgUsername, $firstName, $lastName, $walletAddress) {
        // 1. 验证钱包地址格式
        if (!$this->isValidTronAddress($walletAddress)) {
            throw new Exception('无效的TRON钱包地址格式');
        }

        // 2. 查询是否已有绑定
        $existingBinding = PlayerWalletBinding::where('group_id', $groupId)
            ->where('tg_user_id', $tgUserId)
            ->first();

        if ($existingBinding) {
            // 更新现有绑定
            $existingBinding->update([
                'wallet_address' => $walletAddress,
                'tg_username' => $tgUsername,
                'tg_first_name' => $firstName,
                'tg_last_name' => $lastName,
                'status' => 1,
                'bind_at' => now(),
                'unbind_at' => null
            ]);
        } else {
            // 创建新绑定
            PlayerWalletBinding::create([
                'group_id' => $groupId,
                'tg_user_id' => $tgUserId,
                'tg_username' => $tgUsername,
                'tg_first_name' => $firstName,
                'tg_last_name' => $lastName,
                'wallet_address' => $walletAddress,
                'status' => 1,
                'bind_at' => now()
            ]);
        }

        // 3. 推送成功通知
        $message = "✅ 钱包绑定成功！\n\n";
        $message .= "您的 Telegram 账号已绑定钱包地址：\n";
        $message .= "{$walletAddress}\n\n";
        $message .= "使用该地址参与游戏中奖后，机器人会自动@您通知。\n";
        $message .= "您可以使用 /mywallet 查看绑定信息。";

        TelegramBot::sendPrivateMessage($tgUserId, $message);
        return true;
    }

    /**
     * 解绑钱包地址
     */
    public function unbindWallet($groupId, $tgUserId) {
        $binding = PlayerWalletBinding::where('group_id', $groupId)
            ->where('tg_user_id', $tgUserId)
            ->where('status', 1)
            ->first();

        if (!$binding) {
            throw new Exception('您尚未绑定钱包地址');
        }

        // 标记为已解绑
        $binding->update([
            'status' => 0,
            'unbind_at' => now()
        ]);

        $message = "✅ 钱包解绑成功！\n\n";
        $message .= "您已解绑钱包地址：{$binding->wallet_address}";
        TelegramBot::sendPrivateMessage($tgUserId, $message);

        return true;
    }

    /**
     * 查询我的钱包绑定
     */
    public function getMyWallet($groupId, $tgUserId) {
        $binding = PlayerWalletBinding::where('group_id', $groupId)
            ->where('tg_user_id', $tgUserId)
            ->where('status', 1)
            ->first();

        if (!$binding) {
            $message = "❌ 您尚未绑定钱包地址\n\n";
            $message .= "使用 /bindwallet <地址> 命令绑定钱包";
        } else {
            $message = "📱 您的钱包绑定信息：\n\n";
            $message .= "钱包地址：{$binding->wallet_address}\n";
            $message .= "绑定时间：{$binding->bind_at}\n\n";
            $message .= "使用该地址参与游戏中奖后，机器人会自动@您通知。";
        }

        TelegramBot::sendPrivateMessage($tgUserId, $message);
        return $binding;
    }

    /**
     * 验证TRON地址格式
     */
    private function isValidTronAddress($address) {
        // TRON地址：以T开头，34位字符，Base58编码
        return preg_match('/^T[a-zA-Z0-9]{33}$/', $address);
    }
}
```

#### 5.3.6 钱包地址变更流程
```php
class WalletChangeService {
    /**
     * 开始钱包变更（管理员执行 /wallet 命令）
     */
    public function startWalletChange($groupId, $newWalletAddress, $adminUsername) {
        // 1. 验证新地址格式
        if (!$this->isValidTronAddress($newWalletAddress)) {
            throw new Exception('无效的TRON钱包地址格式');
        }

        // 2. 查询群组信息
        $group = GameGroup::find($groupId);

        // 3. 检查是否已在变更中
        if ($group->wallet_change_status === 'changing') {
            throw new Exception('钱包变更正在进行中，请等待完成或先取消');
        }

        // 4. 更新群组状态
        $startTime = now();
        $endTime = $startTime->copy()->addMinutes(10);

        $group->update([
            'pending_wallet_address' => $newWalletAddress,
            'wallet_change_status' => 'changing',
            'wallet_change_start_at' => $startTime,
            'wallet_change_end_at' => $endTime
        ]);

        // 5. 发送开始变更通知
        $this->sendStartNotification($groupId, $group, $adminUsername, $startTime, $endTime);

        return true;
    }

    /**
     * 取消钱包变更（管理员执行 /cancelwallet 命令）
     */
    public function cancelWalletChange($groupId, $adminUsername) {
        $group = GameGroup::find($groupId);

        if ($group->wallet_change_status !== 'changing') {
            throw new Exception('当前没有进行中的钱包变更');
        }

        // 清除变更状态
        $group->update([
            'pending_wallet_address' => null,
            'wallet_change_status' => 'normal',
            'wallet_change_start_at' => null,
            'wallet_change_end_at' => null
        ]);

        // 发送取消通知
        $message = "❌ 钱包地址变更已取消\n\n";
        $message .= "管理员 @{$adminUsername} 已取消钱包地址变更操作\n\n";
        $message .= "当前地址保持不变：\n";
        $message .= "{$group->wallet_address}\n\n";
        $message .= "🎮 游戏已恢复正常，可以继续转账参与！";

        TelegramBot::sendMessage($groupId, $message);

        return true;
    }

    /**
     * 完成钱包变更（定时任务触发）
     */
    public function completeWalletChange($groupId) {
        $group = GameGroup::find($groupId);

        if ($group->wallet_change_status !== 'changing') {
            return false;
        }

        // 检查是否到了变更时间
        if (now()->lt($group->wallet_change_end_at)) {
            return false;
        }

        // 开启数据库事务
        DB::beginTransaction();
        try {
            // 1. 增加钱包变更次数（钱包周期+1）
            $newWalletCycle = $group->wallet_change_count + 1;

            // 2. 归档所有活跃的蛇身节点（清空当前游戏状态）
            SnakeNode::where('group_id', $groupId)
                ->where('status', 'active')
                ->update([
                    'status' => 'archived',
                    'updated_at' => now()
                ]);

            // 3. 统计被归档的节点数量（用于通知）
            $archivedCount = SnakeNode::where('group_id', $groupId)
                ->where('status', 'archived')
                ->where('wallet_cycle', $group->wallet_change_count)
                ->count();

            // 4. 计算被清空的奖池金额
            $archivedNodes = SnakeNode::where('group_id', $groupId)
                ->where('status', 'archived')
                ->where('wallet_cycle', $group->wallet_change_count)
                ->get();
            $poolAmount = $archivedNodes->sum('amount');

            // 5. 更新群组配置
            $oldAddress = $group->wallet_address;
            $newAddress = $group->pending_wallet_address;

            $group->update([
                'wallet_address' => $newAddress,
                'wallet_change_count' => $newWalletCycle,
                'pending_wallet_address' => null,
                'wallet_change_status' => 'normal',
                'wallet_change_start_at' => null,
                'wallet_change_end_at' => null
            ]);

            DB::commit();

            // 6. 发送完成通知
            $message = "✅ 钱包地址变更成功！\n\n";
            $message .= "新收款地址：{$newAddress}\n\n";
            $message .= "━━━━━━━━━━━━━━━━━━━━\n";
            $message .= "🔄 游戏状态已重置\n\n";
            $message .= "• 旧钱包周期：第 {$group->wallet_change_count} 期\n";
            $message .= "• 新钱包周期：第 {$newWalletCycle} 期\n";
            $message .= "• 已归档节点：{$archivedCount} 个\n";
            $message .= "• 清空奖池：{$poolAmount} TRX\n\n";
            $message .= "━━━━━━━━━━━━━━━━━━━━\n";
            $message .= "🎮 全新游戏已开启\n\n";
            $message .= "现在可以向新地址转账开启新的游戏了！\n";
            $message .= "旧地址的转账将不再被处理。\n\n";
            $message .= "💡 历史中奖记录已保留，可通过 /history 查看\n";
            $message .= "使用 /info 查看最新配置";

            TelegramBot::sendMessage($groupId, $message);

            return true;
        } catch (\Exception $e) {
            DB::rollback();
            Log::error('钱包变更失败', [
                'group_id' => $groupId,
                'error' => $e->getMessage()
            ]);
            return false;
        }
    }

    /**
     * 发送开始变更通知
     */
    private function sendStartNotification($groupId, $group, $adminUsername, $startTime, $endTime) {
        // 统计当前游戏状态
        $activeNodes = SnakeNode::where('group_id', $groupId)
            ->where('status', 'active')
            ->get();
        $nodeCount = $activeNodes->count();
        $poolAmount = $activeNodes->sum('amount');

        $message = "⚠️ 重要通知：钱包地址即将变更\n\n";
        $message .= "管理员 @{$adminUsername} 已请求更新收款钱包地址\n\n";
        $message .= "当前地址：{$group->wallet_address}\n";
        $message .= "新地址：{$group->pending_wallet_address}\n\n";
        $message .= "━━━━━━━━━━━━━━━━━━━━\n";
        $message .= "⏰ 变更倒计时：10分钟\n\n";
        $message .= "变更开始：{$startTime->format('Y-m-d H:i:s')}\n";
        $message .= "生效时间：{$endTime->format('Y-m-d H:i:s')}\n\n";
        $message .= "━━━━━━━━━━━━━━━━━━━━\n";
        $message .= "🔄 游戏状态将重置\n\n";
        $message .= "• 当前蛇身节点：{$nodeCount} 个\n";
        $message .= "• 当前奖池金额：{$poolAmount} TRX\n";
        $message .= "• 变更完成后，以上游戏数据将被归档\n";
        $message .= "• 新游戏将从零开始\n\n";
        $message .= "━━━━━━━━━━━━━━━━━━━━\n";
        $message .= "🚫 注意事项：\n";
        $message .= "1. 在此期间请勿向任何地址转账\n";
        $message .= "2. 当前未中奖的购彩凭证将被归档（不退款）\n";
        $message .= "3. 新交易将在地址变更后才会处理\n";
        $message .= "4. 10分钟后系统将自动切换到新地址并重置游戏\n";
        $message .= "5. 历史中奖记录将保留，可通过 /history 查看\n\n";
        $message .= "⚠️ 如需取消变更，请管理员使用 /cancelwallet";

        TelegramBot::sendMessage($groupId, $message);
    }

    /**
     * 验证TRON地址格式
     */
    private function isValidTronAddress($address) {
        return preg_match('/^T[a-zA-Z0-9]{33}$/', $address);
    }
}
```

#### 5.3.7 钱包变更通知定时任务
```php
class WalletChangeNotifier {
    /**
     * 每10秒执行一次
     */
    public function run() {
        // 1. 查询所有正在变更中的群组
        $changingGroups = GameGroup::where('wallet_change_status', 'changing')->get();

        foreach ($changingGroups as $group) {
            $now = now();
            $endTime = $group->wallet_change_end_at;

            // 2. 检查是否已到变更时间
            if ($now->gte($endTime)) {
                // 执行变更
                $this->walletChangeService->completeWalletChange($group->id);
                continue;
            }

            // 3. 计算剩余时间
            $remainingSeconds = $endTime->diffInSeconds($now);
            $minutes = floor($remainingSeconds / 60);
            $seconds = $remainingSeconds % 60;

            // 4. 发送倒计时提醒
            $message = "⏰ 钱包地址变更倒计时\n\n";
            $message .= sprintf("剩余时间：%02d:%02d\n", $minutes, $seconds);
            $message .= "新地址将在 {$endTime->format('Y-m-d H:i:s')} 生效\n\n";
            $message .= "🚫 请勿转账到旧地址，否则将无法退款！";

            TelegramBot::sendMessage($group->tg_chat_id, $message);
        }
    }
}
```

#### 5.3.8 交易处理时的状态检查
```php
class TronMonitorService {
    public function processTransaction($groupId, $txHash) {
        // 1. 获取群组配置
        $group = GameGroup::find($groupId);

        // 2. 检查钱包变更状态
        if ($group->wallet_change_status === 'changing') {
            // 正在变更中，拒绝处理新交易
            $this->sendRejectMessage($groupId, $txHash);
            return false;
        }

        // 3. 获取交易详情
        $tx = TronAPI::getTransactionByHash($txHash);

        // 4. 验证接收地址（必须是当前生效的地址）
        if ($tx['to'] !== $group->wallet_address) {
            // 发送到错误地址的提醒
            $this->sendWrongAddressMessage($groupId, $txHash, $tx['to'], $group->wallet_address);
            return false;
        }

        // 5. 继续正常处理流程
        // ...
    }

    private function sendRejectMessage($groupId, $txHash) {
        $message = "⚠️ 交易暂不处理\n\n";
        $message .= "交易哈希：{$txHash}\n\n";
        $message .= "原因：群组钱包地址正在变更中\n";
        $message .= "请等待变更完成后再进行转账\n\n";
        $message .= "使用 /info 查看群组状态";

        TelegramBot::sendMessage($groupId, $message);
    }

    private function sendWrongAddressMessage($groupId, $txHash, $wrongAddress, $correctAddress) {
        $message = "❌ 转账地址错误\n\n";
        $message .= "交易哈希：{$txHash}\n\n";
        $message .= "您转账到了：{$wrongAddress}\n";
        $message .= "正确地址：{$correctAddress}\n\n";
        $message .= "⚠️ 该交易将不会被处理，请向正确地址转账\n";
        $message .= "使用 /info 查看当前收款地址";

        TelegramBot::sendMessage($groupId, $message);
    }
}
```

---

## 6. 安全性考虑

### 6.1 资金安全

#### 6.1.1 钱包安全
- ✅ 热钱包只存放必要的运营资金
- ✅ 大额资金存放在冷钱包
- ✅ 定期审计钱包余额
- ✅ 异常交易告警（大额转出、高频转账等）

#### 6.1.2 转账安全
- ✅ 转账前二次确认
- ✅ 限制单笔最大转账金额
- ✅ 限制每日最大转账次数
- ✅ 关键操作记录日志

### 6.2 业务安全

#### 6.2.1 防刷机制
- ✅ 同一地址限制投注频率（如：最快 1 分钟一次）
- ✅ 检测异常投注模式（如：大量小号同时投注相同数字）
- ✅ IP 白名单/黑名单机制

#### 6.2.2 数据安全
- ✅ 敏感数据加密存储
- ✅ API 接口鉴权
- ✅ 防止 SQL 注入
- ✅ 定期数据库备份

### 6.3 合规性

#### 6.3.1 反洗钱（AML）
- ⚠️ 记录所有交易链路
- ⚠️ 可疑交易标记和人工审核
- ⚠️ 满足当地监管要求

#### 6.3.2 KYC（了解你的客户）
- 🔴 **高风险提示：** 涉及资金游戏可能需要用户实名认证
- 建议：
  - 租户需提供营业执照
  - 大额中奖需验证身份
  - 保留必要的用户信息记录

---

## 7. 运营与管理

### 7.1 后台管理功能

#### 7.1.1 租户管理
- 租户列表/新增/编辑
- 租户状态管理（启用/停用）
- 查看租户的所有群组

#### 7.1.2 群组管理
- 群组列表
- 群组配置（钱包、投注金额、手续费比例）
- 群组数据统计
- 手动暂停/恢复游戏

**手续费配置：**
- 可通过后台界面设置每个群组的手续费比例
- 取值范围：0% ~ 50%（0.0000 ~ 0.5000）
- 默认值：10%（0.1000）
- 修改后立即生效，不影响历史记录
- 显示手续费收入统计

#### 7.1.3 游戏监控
- 实时蛇身展示
- 交易监听状态
- 待处理交易队列
- 异常交易告警

#### 7.1.4 财务管理
- 钱包余额监控
- 充值记录
- 提现记录
- 平台手续费收益统计
- 手续费明细查询（按群组、按时间）

**手续费统计维度：**
- 今日手续费收入
- 本周手续费收入
- 本月手续费收入
- 按群组分类统计
- 手续费占比分析

#### 7.1.5 用户管理
- 玩家列表
- 玩家投注记录
- 玩家中奖记录
- 黑名单管理

### 7.2 数据统计

#### 7.2.1 群组维度
- 总投注金额
- 总中奖金额
- 平台手续费收入
- 净奖金支出（中奖金额 - 手续费）
- 参与玩家数
- 投注次数
- 中奖次数
- 手续费比例变更历史

#### 7.2.2 租户维度
- 汇总所有群组数据
- 租户排行榜

#### 7.2.3 平台维度
- 总交易量
- 总用户数
- DAU/MAU
- 留存率

---

## 8. 用户体验优化

### 8.1 新手引导

#### 8.1.1 首次加入群组
1. 机器人自动发送欢迎消息
2. 简明游戏规则介绍
3. 钱包地址和投注金额提示
4. 示例演示

#### 8.1.2 游戏规则文档
- 图文并茂的规则说明
- 常见问题FAQ
- 视频教程（可选）

### 8.2 消息优化

#### 8.2.1 消息聚合
- 短时间内多个购彩消息合并推送
- 避免刷屏

#### 8.2.2 消息美化
- 使用 Emoji 图标
- Markdown 格式排版
- 颜色区分（成功/失败/警告）

### 8.3 互动性

#### 8.3.3 游戏氛围
- 显示当前参与人数
- 显示历史最高奖金
- 中奖玩家排行榜
- 幸运数字统计（哪些数字最容易中奖）

---

## 9. 风险评估

### 9.1 技术风险

| 风险项 | 风险等级 | 应对措施 |
|-------|---------|---------|
| TRON 网络拥堵 | 中 | 提高 Gas 费用，延长确认时间 |
| API 限流 | 中 | 使用多个 API Key 轮询，自建节点 |
| 服务器宕机 | 高 | 高可用架构，自动故障转移 |
| 数据丢失 | 高 | 实时备份，多地容灾 |

### 9.2 业务风险

| 风险项 | 风险等级 | 应对措施 |
|-------|---------|---------|
| 恶意刷奖 | 中 | 防刷机制，人工审核 |
| 资金不足 | 高 | 余额监控，自动告警 |
| 法律合规 | 高 | 咨询律师，满足当地法规 |
| 用户纠纷 | 中 | 完整日志记录，客服支持 |

### 9.3 市场风险

| 风险项 | 风险等级 | 应对措施 |
|-------|---------|---------|
| 用户活跃度低 | 中 | 优化游戏机制，增加趣味性 |
| 竞品出现 | 低 | 持续创新，提升体验 |
| TRX 价格波动 | 低 | 使用稳定币（USDT-TRC20）替代 |

---

## 10. 项目排期

### 10.1 开发阶段

| 阶段 | 内容 | 工期 | 交付物 |
|-----|------|------|--------|
| **Phase 1** | 基础架构 | 1周 | 数据库设计、项目框架搭建 |
| **Phase 2** | TRON 集成 | 2周 | 交易监听、凭证生成、自动转账 |
| **Phase 3** | Telegram Bot | 1周 | 命令处理、消息推送 |
| **Phase 4** | 游戏逻辑 | 2周 | 蛇身拼接、中奖匹配 |
| **Phase 5** | 后台管理 | 2周 | 租户管理、数据统计 |
| **Phase 6** | 测试优化 | 1周 | 功能测试、性能优化 |

**总工期：9周**

### 10.2 测试阶段

| 阶段 | 内容 | 工期 |
|-----|------|------|
| 内测 | 小范围测试，修复 Bug | 1周 |
| 公测 | 开放测试，收集反馈 | 2周 |

### 10.3 上线计划

- **上线前准备：** 服务器部署、域名配置、安全审计
- **灰度发布：** 先上线 1-2 个测试群组
- **全量发布：** 无重大问题后全面开放

---

## 11. 后续扩展

### 11.1 功能扩展

#### 11.1.1 多链支持
- 支持以太坊（ETH）
- 支持币安链（BSC）
- 支持波卡（Polkadot）

#### 11.1.2 游戏模式
- **经典模式：** 当前的贪吃蛇模式
- **快速模式：** 缩短蛇身长度，加快游戏节奏
- **PK 模式：** 两个群组对战
- **赛季模式：** 按周/月结算排行榜

#### 11.1.3 社交功能
- 玩家个人主页
- 成就系统
- 邀请好友奖励
- 群组排行榜

### 11.2 商业化

#### 11.2.1 收费模式
- 租户月费/年费
- 平台抽成（已实现）
- 广告收入

#### 11.2.2 增值服务
- 自定义群组主题
- 专属客服支持
- 数据分析报告

---

## 12. 附录

### 12.1 名词解释

| 术语 | 解释 |
|-----|------|
| **TRX** | TRON 网络原生代币 |
| **TRON** | 波场区块链，去中心化公链 |
| **哈希** | 交易的唯一标识符 |
| **购彩凭证** | 从交易哈希提取的两位数字 |
| **蛇身** | 按时间顺序排列的购彩凭证序列 |
| **热钱包** | 联网的钱包，用于日常交易 |
| **冷钱包** | 离线存储的钱包，安全性高 |

### 12.2 TRON 地址示例
```
有效地址：TXYZa2kR6MRWPCsqcBaFCwV9XABqnhYcxk
前缀：T
长度：34 位
字符集：Base58（大小写字母+数字，不含 0OIl）
```

### 12.3 参考资料

- [TRON 官方文档](https://developers.tron.network/)
- [TronWeb JS SDK](https://github.com/tronprotocol/tronweb)
- [TronGrid API](https://www.trongrid.io/)
- [Telegram Bot API](https://core.telegram.org/bots/api)

---

## 13. 版本历史

| 版本 | 日期 | 修订内容 | 作者 |
|-----|------|---------|------|
| v1.0 | 2025-01-08 | 初始版本，完整需求文档 | Claude |
| v1.1 | 2025-01-08 | 新增连号清空奖池机制（超级大奖） | Claude |
| v1.2 | 2025-01-08 | 新增玩家钱包绑定功能，支持@用户中奖通知 | Claude |
| v1.3 | 2025-01-08 | 新增凭证流水号和每日序号，优化查询功能 | Claude |
| v1.4 | 2025-01-08 | 完善平台手续费机制，支持自定义手续费比例（默认10%） | Claude |
| v1.5 | 2025-01-08 | 新增钱包地址变更冷却期机制（10分钟+倒计时通知） | Claude |
| v1.6 | 2025-01-08 | 完善钱包变更游戏重置机制（归档节点、清空奖池、钱包周期管理） | Claude |
| v1.7 | 2025-01-09 | 新增 `/address` 命令，允许所有群友查看当前群收款钱包地址 | Claude |

---

**文档状态：** ✅ 已完成
**审核状态：** 🔄 待产品经理确认
**预计开工日期：** TBD
